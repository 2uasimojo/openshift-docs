////
Module included in the following assemblies:
install_config/configuring_for_rhv.adoc
////
[id='creating_the_bastion_virtual_machine_{context}']
= Creating the bastion virtual machine

Create a bastion virtual machine in Red Hat Virtualization to install {product-title}.

.Procedure

. Log in to the Manager machine by using SSH.
. Create a temporary bastion installation directory, for example, *_/bastion_installation_*, for the installation files.
. Create an encrypted *_/bastion_installation/secure_vars.yaml_* file with `ansible-vault` and record the password:
+
[options="nowrap" subs="+quotes,verbatim"]
----
# ansible-vault create secure_vars.yaml
----

. Add the following parameter values to the *_secure_vars.yaml_* file:
+
[source,yml]
----
engine_password: <Manager_password> <1>
bastion_root_password: <bastion_root_password> <2>
rhsub_user: <Red_Hat_Subscription_Manager_username> <3>
rhsub_pass: <Red_Hat_Subscription_Manager_password>
rhsub_pool: <Red_Hat_Subscription_Manager_pool_id> <4>
root_password: <OpenShift_node_root_password> <5>
engine_cafile: <RHVM_CA_certificate> <6>
oreg_auth_user: <image_registry_authentication_username> <7>
oreg_auth_password: <image_registry_authentication_password>
----
<1> Password for logging in to the Administration Portal.
<2> Root password for the bastion virtual machine.
<3> Red Hat Subscription Manager credentials.
<4> Pool ID of the Red Hat Virtualization Manager subscription pool.
<5> {product-title} root password.
<6> Red Hat Virtualization Manager CA certificate. The `engine_cafile` value is required if you are not running the playbook from the Manager machine. The Manager CA certificate's default location is *_/etc/pki/ovirt-engine/ca.pem_*.
<7> If you are using an image registry that requires authentication, add the credentials.

. Save the file.

. Obtain the *_Red Hat Enterprise Linux KVM Guest Image_* download link:

.. Navigate to link:https://access.redhat.com/downloads/content/69/ver=/rhel---7/latest/x86_64/product-software[Red Hat Customer Portal: Download Red Hat Enterprise Linux].
.. In the *Product Software* tab, locate the *_Red Hat Enterprise Linux KVM Guest Image_*.
.. Right-click *Download Now*, copy the link, and save it.
+
The link is time-sensitive and must be copied just before you create the bastion virtual machine.

. Create the *_/bastion_installation/create-bastion-machine-playbook.yaml_* file with the following content and update its parameter values:
+
[source,yml]
----
---
- name: Create a bastion machine
  hosts: localhost
  connection: local
  gather_facts: false
  no_log: true

  roles:
    - oVirt.image-template
    - oVirt.vm-infra
  no_log: true

  vars:
    engine_url: https://_Manager_FQDN_/ovirt-engine/api <1>
    engine_user: <admin@internal>
    engine_password: "{{ engine_password }}"
    engine_cafile: /etc/pki/ovirt-engine/ca.pem

    qcow_url: <RHEL_KVM_guest_image_download_link> <2>
    template_cluster: Default
    template_name: rhelguest7
    template_memory: 4GiB
    template_cpu: 2
    wait_for_ip: true
    debug_vm_create: false

    vms:
    - name: rhel-bastion
      cluster: "{{ template_cluster }}"
      profile:
        cores: 2
        template: "{{ template_name }}"
        root_password: "{{ root_password }}"
        ssh_key: "{{ lookup('file', '/root/.ssh/id_rsa_ssh_ocp_admin.pub') }}"
        state: running
      cloud_init:
        custom_script: |
          rh_subscription:
            username: "{{ rhsub_user }}"
            password: "{{ rhsub_pass }}"
            auto-attach: true
            disable-repo: ['*']
            # 'rhel-7-server-rhv-4.2-manager-rpms' supports RHV 4.2 and 4.3
            enable-repo: ['rhel-7-server-rpms', 'rhel-7-server-extras-rpms', 'rhel-7-server-ansible-2.7-rpms', 'rhel-7-server-ose-3.11-rpms', 'rhel-7-server-supplementary-rpms', 'rhel-7-server-rhv-4.2-manager-rpms']
          packages:
            - ansible
            - ovirt-ansible-roles
            - openshift-ansible
            - python-ovirt-engine-sdk4
  pre_tasks:
    - name: Create an ssh key-pair for OpenShift admin
      user:
        name: root
        generate_ssh_key: yes
        ssh_key_file: .ssh/id_rsa_ssh_ocp_admin

  roles:
    - oVirt.image-template
    - oVirt.vm-infra

- name: post installation tasks on the bastion machine
  hosts: rhel-bastion
  tasks:
    - name: create ovirt-engine PKI dir
      file:
        state: directory
        dest: /etc/pki/ovirt-engine/
    - name: Copy the engine ca cert to the bastion machine
      copy:
        src: "{{ engine_cafile }}"
        dest: "{{ engine_cafile }}"
    - name: Copy the secured vars to the bastion machine
      copy:
        src: secure_vars.yaml
        dest: secure_vars.yaml
        decrypt: false
    - file:
        state: directory
        path: /root/.ssh
    - name: copy the OpenShift_admin keypair to the bastion machine
      copy:
        src: "{{ item }}"
        dest: "{{ item }}"
        mode: 0600
      with_items:
        - /root/.ssh/id_rsa_ssh_ocp_admin
        - /root/.ssh/id_rsa_ssh_ocp_admin.pub
----
<1> FQDN of the Manager machine.
<2> `<qcow_url>` is the download link of the *_Red Hat Enterprise Linux KVM Guest Image_*. The *_Red Hat Enterprise Linux KVM Guest Image_* includes the `cloud-init` package, which is required by this playbook. If you are not using Red Hat Enterprise Linux, download the link:https://access.redhat.com/downloads/content/69/ver=/rhel---7/7.7/x86_64/packages[`cloud-init` package] and install it manually before running this playbook.

. Create the bastion virtual machine:
+
[options="nowrap" subs="+quotes,verbatim"]
----
# ansible-playbook -i localhost create-bastion-machine-playbook.yaml -e @secure_vars.yaml --ask-vault-pass
----

. Log in to the Administration Portal.
. Click menu:Compute[Virtual Machines] to verify that the *_rhel-bastion_* virtual machine was created successfully.
